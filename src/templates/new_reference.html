{% extends "layout.html" %} {% block title %} Create a new reference {% endblock
%} {% block body %}

<h2>Create a new reference</h2>

<form action="/create_reference" method="post">
  {% with messages = get_flashed_messages() %} {% if messages %}
  <ul>
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %} {% endwith %}
  <label for="cite_key">Cite Key:</label>
  <input type="text" name="cite_key" value="{{ cite_key or '' }}" required />
  <br />
  <br />

  <label for="title">Title:</label>
  <input type="text" name="title" value="{{ title or '' }}" required />
  <br />
  <br />

  <label for="author">Author(s) add one per field (Lastname, Firstname):</label>
  <div id="author-fields">
    {% set authors = (authors_formatted|default('')).split(';') %}
    {% if authors and authors[0].strip() %}
      {% for a in authors %}
        <input type="text" name="authors" value="{{ a.strip() }}" />
      {% endfor %}
    {% else %}
      <input type="text" name="authors" />
    {% endif %}
  </div>
  <button type="button" id="add-author">+ Add Author</button>
  <script>
    document
      .getElementById("add-author")
      .addEventListener("click", function (e) {
        e.preventDefault();
        const input = document.createElement("input");
        input.type = "text";
        input.name = "authors";
        document.getElementById("author-fields").appendChild(input);
      });

    // Format authors on form submit
    document.querySelector("form").addEventListener("submit", function (e) {
      const authorInputs = document.querySelectorAll('input[name="authors"]');
      const authorNames = Array.from(authorInputs)
        .map((input) => input.value.trim())
        .filter((name) => name.length > 0);
      
      // Remove any previous hidden authors_formatted input
      const existing = this.querySelector('input[name="authors_formatted"]');
      if (existing) existing.remove();

      // Create hidden input with formatted authors
      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "authors_formatted";
      hiddenInput.value = authorNames.join("; ");
      this.appendChild(hiddenInput);
    });
  </script>
  <br />
  <br />

  <label for="year">Year:</label>
  <input
    type="number"
    name="year"
    min="0"
    max="{{ curr_year }}"
    value="{{ year or curr_year }}"
    required
  />
  <br />
  <br />

  <label for="publisher">Publisher:</label>
  <input type="text" name="publisher" value="{{ publisher or '' }}" required />
  <br />
  <br />

  <button type="submit">Create</button>
</form>

{% endblock %}
