{% extends "layout.html" %} {% block title %} Edit reference {% endblock %} {% block body %}

<h2>Edit reference</h2>

<form action="/reference/{{ reference.id }}/edit" method="post">
  {% with messages = get_flashed_messages() %} {% if messages %}
  <ul>
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %} {% endwith %}

  <label for="cite_key">Cite Key:</label>
  <input type="text" name="cite_key" value="{{ reference.cite_key or '' }}" required />
  <br />
  <br />

  <label for="title">Title:</label>
  <input type="text" name="title" value="{{ reference.title or '' }}" required />
  <br />
  <br />

  <label for="author">Author(s) add one per field (Lastname, Firstname):</label>
  <div id="author-fields">
    {% set authors = (reference.author|default('')).split(';') %}
    {% if not authors[0].strip() %}
    <input type="text" name="authors" />
    {% else %}
    {% for a in authors %}
    <input type="text" name="authors" value="{{ a.strip() }}" />
    {% endfor %}
    {% endif %}
  </div>
  <button type="button" id="add-author">+ Add Author</button>

  <script>
    document.getElementById("add-author").addEventListener("click", function (e) {
      e.preventDefault();
      const input = document.createElement("input");
      input.type = "text";
      input.name = "authors";
      document.getElementById("author-fields").appendChild(input);
    });

    // Format authors on form submit
    document.querySelector("form").addEventListener("submit", function (e) {
      const authorInputs = document.querySelectorAll('input[name="authors"]');
      const authorNames = Array.from(authorInputs)
        .map((input) => input.value.trim())
        .filter((name) => name.length > 0);

      // Remove any previous hidden authors_formatted input
      const existing = this.querySelector('input[name="authors_formatted"]');
      if (existing) existing.remove();

      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "authors_formatted";
      hiddenInput.value = authorNames.join("; ");
      this.appendChild(hiddenInput);
    });
  </script>
  <br />
  <br />

  <label for="year">Year:</label>
  <input type="number" name="year" min="0" max="{{ curr_year }}" value="{{ reference.year or curr_year }}" required />
  <br />
  <br />

  <label for="publisher">Publisher:</label>
  <input type="text" name="publisher" value="{{ reference.publisher or '' }}" required />
  <br />
  <br />

  <button type="submit">Save</button>
  <button type="submit" name="cancel" formnovalidate>Cancel</button>
</form>

{% endblock %}