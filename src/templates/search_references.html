{% extends "layout.html" %} {% block title %} Search references {% endblock %}
{% block body %}

<h2>Search references</h2>
  
<div class="search-container">
  <!-- Toggle between simple and advanced search -->
  <div style="margin-bottom: 15px;">
    {% if advanced_mode %}
    <button class="btn-neutral" type="button" onclick="window.location.href='/search_references'">
      Switch to Simple Search
    </button>
    {% else %}
    <button class="btn-neutral" type="button" onclick="window.location.href='/search_references?advanced=true'">
      Switch to Advanced Search
    </button>
    {% endif %}
  </div>

  {% if advanced_mode %}
  <!-- Advanced Search Form -->
  <form action="/search_references" method="get">
    <input type="hidden" name="advanced" value="true">
    
    <div class="search-field">
      <label for="title">Title:</label>
      <input type="text" name="title" id="title" value="{{ filters.title or '' }}" placeholder="Search by title..." />
    </div>

    <div class="search-field">
      <label for="author">Author:</label>
      <input type="text" name="author" id="author" value="{{ filters.author or '' }}" placeholder="Search by author..." />
    </div>

    <div class="search-field">
      <label for="reference_type">Reference Type:</label>
      <select name="reference_type" id="reference_type">
        <option value="all" {% if filters.reference_type == 'all' %}selected{% endif %}>All Types</option>
        <option value="article" {% if filters.reference_type == 'article' %}selected{% endif %}>Article</option>
        <option value="book" {% if filters.reference_type == 'book' %}selected{% endif %}>Book</option>
        <option value="inproceedings" {% if filters.reference_type == 'inproceedings' %}selected{% endif %}>Inproceedings</option>
        <option value="misc" {% if filters.reference_type == 'misc' %}selected{% endif %}>Misc</option>
      </select>
    </div>

    <div class="search-field">
      <label for="year_from">Year From:</label>
      <input type="number" name="year_from" id="year_from" value="{{ filters.year_from or '' }}" placeholder="e.g., 2000" />
    </div>

    <div class="search-field">
      <label for="year_to">Year To:</label>
      <input type="number" name="year_to" id="year_to" value="{{ filters.year_to or '' }}" placeholder="e.g., 2024" />
    </div>

    <div class="search-field">
      <label for="cite_key">Cite Key:</label>
      <input type="text" name="cite_key" id="cite_key" value="{{ filters.cite_key or '' }}" placeholder="Search by cite key..." />
    </div>

    <div class="search-field">
      <label for="journal">Journal:</label>
      <input type="text" name="journal" id="journal" value="{{ filters.journal or '' }}" placeholder="For articles..." />
    </div>

    <div class="search-field">
      <label for="publisher">Publisher:</label>
      <input type="text" name="publisher" id="publisher" value="{{ filters.publisher or '' }}" placeholder="For books..." />
    </div>

    <button class="btn-create" type="submit">Search</button>
    <button class="btn-neutral" type="button" onclick="window.location.href='/search_references?advanced=true'">
      Clear Filters
    </button>
    <button class="btn-neutral" type="button" onclick="window.location.href='/'">
      Back to Home
    </button>
  </form>
  {% else %}
  <!-- Simple Search Form -->
  <form action="/search_references" method="get">
    
    <div class="search-field">
      <label for="query">Search:</label>
      <input type="text" name="query" id="query" value="{{ query or '' }}" placeholder="Search by type, title, author, year, cite key, etc..." />
    </div>

    <button class="btn-create" type="submit">Search</button>
    <button class="btn-neutral" type="button" onclick="window.location.href='/'">
      Back to Home
    </button>
  </form>
  {% endif %}
</div>

{% if show_results %}
<div id="results">
  <h3>Search results: {{ results|length }}</h3>

  <div>
    <p>
      <button
        class="btn-create"
        type="button"
        onclick="document.getElementById('export-form').submit()"
      >
        Export BibTeX
      </button>

      <label>
        <input type="checkbox" id="select-all">
        Select all
      </label>
    </p>
  </div>

  {% with messages = get_flashed_messages() %} {% if messages %}
    <ul>
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %} {% endwith %}
</div>
<form id="export-form" action="/preview_bibtex" method="POST">
  <input type="hidden" name="from_search" value="true">
  {% if advanced_mode %}
  <input type="hidden" name="advanced" value="true">
  <input type="hidden" name="title" value="{{ filters.title }}">
  <input type="hidden" name="author" value="{{ filters.author }}">
  <input type="hidden" name="year_from" value="{{ filters.year_from }}">
  <input type="hidden" name="year_to" value="{{ filters.year_to }}">
  <input type="hidden" name="reference_type" value="{{ filters.reference_type }}">
  <input type="hidden" name="cite_key" value="{{ filters.cite_key }}">
  <input type="hidden" name="journal" value="{{ filters.journal }}">
  <input type="hidden" name="publisher" value="{{ filters.publisher }}">
  {% else %}
  <input type="hidden" name="query" value="{{ query }}">
  {% endif %}
  <div class="references-list">
    {% for reference in results %}
    <div class="reference-card">
      <div class="reference-header">
        <input
          type="checkbox"
          name="reference_ids"
          value="{{ reference.id }}"
          id="checkbox-{{ loop.index }}"
        />
        <a class="reference-title" href="/reference/{{ reference.id }}"
          >{{ reference.title }}</a
        >
      </div>

      <div class="reference-meta">
        <p><strong>Author(s):</strong> {{ reference.author }}</p>
        <p><strong>Year:</strong> {{ reference.year }}</p>
        <p><strong>Type:</strong> {{ reference.reference_type }}</p>
        <p><strong>Cite key:</strong> {{ reference.cite_key }}</p>
        {% if reference.reference_type == "book" %} {% if reference.publisher %}
        <p><strong>Publisher:</strong> {{ reference.publisher }}</p>
        {% endif %} {% if reference.chapter %}
        <p><strong>Chapter:</strong> {{ reference.chapter }}</p>
        {% endif %} {% elif reference.reference_type == "article" %} {% if
        reference.journal %}
        <p><strong>Journal:</strong> {{ reference.journal }}</p>
        {% endif %} {% if reference.volume %}
        <p><strong>Volume:</strong> {{ reference.volume }}</p>
        {% endif %} {% if reference.pages %}
        <p><strong>Pages:</strong> {{ reference.pages }}</p>
        {% endif %} {% elif reference.reference_type == "inproceedings" %} {% if
        reference.booktitle %}
        <p><strong>Booktitle:</strong> {{ reference.booktitle }}</p>
        {% endif %} {% elif reference.reference_type == "misc" %} {% if
        reference.url %}
        <p><strong>Url:</strong> {{ reference.url }}</p>
        {% endif %} {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</form>

{% endif %}
{% endblock %}